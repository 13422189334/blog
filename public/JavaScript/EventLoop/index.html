<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript 执行机制 | 繁华中自律，落魄中自愈</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3077305_pt8umhrn4k9.css">
    <link rel="javascript" href="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="Just playing around">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preload" href="/assets/css/0.styles.038b456f.css" as="style"><link rel="preload" href="/assets/js/app.e55f4abd.js" as="script"><link rel="preload" href="/assets/js/3.bc0c2498.js" as="script"><link rel="preload" href="/assets/js/8.97c9f6f1.js" as="script"><link rel="preload" href="/assets/js/22.ced87b4d.js" as="script"><link rel="preload" href="/assets/js/9.e2c20ecd.js" as="script"><link rel="prefetch" href="/assets/js/10.73b02319.js"><link rel="prefetch" href="/assets/js/11.771a938e.js"><link rel="prefetch" href="/assets/js/12.1f060336.js"><link rel="prefetch" href="/assets/js/13.8f8233fa.js"><link rel="prefetch" href="/assets/js/14.fd674787.js"><link rel="prefetch" href="/assets/js/15.6e628831.js"><link rel="prefetch" href="/assets/js/16.6274fae1.js"><link rel="prefetch" href="/assets/js/17.09e690d1.js"><link rel="prefetch" href="/assets/js/18.cebb8b51.js"><link rel="prefetch" href="/assets/js/19.27e1fe6e.js"><link rel="prefetch" href="/assets/js/20.004b2a23.js"><link rel="prefetch" href="/assets/js/21.a98f0ac8.js"><link rel="prefetch" href="/assets/js/23.2bb09f42.js"><link rel="prefetch" href="/assets/js/24.95e99013.js"><link rel="prefetch" href="/assets/js/25.2c9b6391.js"><link rel="prefetch" href="/assets/js/26.8eb9cf48.js"><link rel="prefetch" href="/assets/js/27.3f10de59.js"><link rel="prefetch" href="/assets/js/28.e57ccbac.js"><link rel="prefetch" href="/assets/js/29.cd5dd0f8.js"><link rel="prefetch" href="/assets/js/30.cc6ca8c7.js"><link rel="prefetch" href="/assets/js/31.9eca7298.js"><link rel="prefetch" href="/assets/js/32.0849a8db.js"><link rel="prefetch" href="/assets/js/33.4ac13cf6.js"><link rel="prefetch" href="/assets/js/34.5c6bcbf5.js"><link rel="prefetch" href="/assets/js/35.5b75aee0.js"><link rel="prefetch" href="/assets/js/36.35060f28.js"><link rel="prefetch" href="/assets/js/37.837d3424.js"><link rel="prefetch" href="/assets/js/38.30499463.js"><link rel="prefetch" href="/assets/js/39.1f0fa834.js"><link rel="prefetch" href="/assets/js/4.f32d5f99.js"><link rel="prefetch" href="/assets/js/40.5c697fed.js"><link rel="prefetch" href="/assets/js/41.14276157.js"><link rel="prefetch" href="/assets/js/42.e6dd56b2.js"><link rel="prefetch" href="/assets/js/43.6805bc2f.js"><link rel="prefetch" href="/assets/js/44.2ac70d88.js"><link rel="prefetch" href="/assets/js/45.2b778f9c.js"><link rel="prefetch" href="/assets/js/46.a48f04e4.js"><link rel="prefetch" href="/assets/js/47.883731db.js"><link rel="prefetch" href="/assets/js/48.29bcb66a.js"><link rel="prefetch" href="/assets/js/49.1ebbfafb.js"><link rel="prefetch" href="/assets/js/5.b062ed64.js"><link rel="prefetch" href="/assets/js/50.e0614fce.js"><link rel="prefetch" href="/assets/js/51.5dd3e7ed.js"><link rel="prefetch" href="/assets/js/52.82930a81.js"><link rel="prefetch" href="/assets/js/53.55e7a459.js"><link rel="prefetch" href="/assets/js/54.65434bea.js"><link rel="prefetch" href="/assets/js/55.2b21562c.js"><link rel="prefetch" href="/assets/js/56.edd30b0c.js"><link rel="prefetch" href="/assets/js/57.6ca491a1.js"><link rel="prefetch" href="/assets/js/58.a53bc641.js"><link rel="prefetch" href="/assets/js/59.cacf9050.js"><link rel="prefetch" href="/assets/js/6.d9c84a16.js"><link rel="prefetch" href="/assets/js/60.071b43a3.js"><link rel="prefetch" href="/assets/js/61.1a66292c.js"><link rel="prefetch" href="/assets/js/62.dd0b7a66.js"><link rel="prefetch" href="/assets/js/63.5d515649.js"><link rel="prefetch" href="/assets/js/64.b3d5da93.js"><link rel="prefetch" href="/assets/js/65.0788db0c.js"><link rel="prefetch" href="/assets/js/66.4580a7fb.js"><link rel="prefetch" href="/assets/js/67.264f5b0a.js"><link rel="prefetch" href="/assets/js/68.7a960a93.js"><link rel="prefetch" href="/assets/js/69.07e188e3.js"><link rel="prefetch" href="/assets/js/7.7526e2b2.js"><link rel="prefetch" href="/assets/js/70.7a42c352.js"><link rel="prefetch" href="/assets/js/71.30096cc6.js"><link rel="prefetch" href="/assets/js/72.f15d8bca.js"><link rel="prefetch" href="/assets/js/73.b65622cd.js"><link rel="prefetch" href="/assets/js/74.b648b78e.js"><link rel="prefetch" href="/assets/js/75.f1d52c0f.js"><link rel="prefetch" href="/assets/js/76.3c875b4f.js"><link rel="prefetch" href="/assets/js/77.6bd17ae9.js"><link rel="prefetch" href="/assets/js/78.f315784d.js"><link rel="prefetch" href="/assets/js/79.87db797f.js"><link rel="prefetch" href="/assets/js/80.17fcdc37.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.c750476e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.038b456f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="繁华中自律，落魄中自愈" class="logo"> <span class="site-name can-hide">繁华中自律，落魄中自愈</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/FrontEnd/" class="nav-link">前端知识库</a></div><div class="nav-item"><a href="/BackEnd/" class="nav-link">后端知识库</a></div><div class="nav-item"><a href="/DesignPattern/" class="nav-link">设计模式</a></div><div class="nav-item"><a href="/Algorithm/Dichotomy/" class="nav-link">常用算法</a></div><div class="nav-item"><a href="/Git/" class="nav-link">Git</a></div><div class="nav-item"><a href="/Server/" class="nav-link">服务器</a></div><div class="nav-item"><a href="/Performance/Info/" class="nav-link">性能优化</a></div><div class="nav-item"><a href="/Recommend/" class="nav-link">推荐</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/bingbing.jpg"> <div class="blogger-info"><h3>石怜安</h3> <span>在线找大长腿小姐姐</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/FrontEnd/" class="nav-link">前端知识库</a></div><div class="nav-item"><a href="/BackEnd/" class="nav-link">后端知识库</a></div><div class="nav-item"><a href="/DesignPattern/" class="nav-link">设计模式</a></div><div class="nav-item"><a href="/Algorithm/Dichotomy/" class="nav-link">常用算法</a></div><div class="nav-item"><a href="/Git/" class="nav-link">Git</a></div><div class="nav-item"><a href="/Server/" class="nav-link">服务器</a></div><div class="nav-item"><a href="/Performance/Info/" class="nav-link">性能优化</a></div><div class="nav-item"><a href="/Recommend/" class="nav-link">推荐</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=FrontEnd" title="分类" data-v-1baff76c>FrontEnd</a></li><li data-v-1baff76c><a href="/categories/?category=JavaScript" title="分类" data-v-1baff76c>JavaScript</a></li><li data-v-1baff76c><a href="/categories/?category=EventLoop" title="分类" data-v-1baff76c>EventLoop</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="404" target="_blank" title="作者" class="beLink" data-v-1baff76c>JSH</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-06-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="/bingbing.jpg">JavaScript 执行机制<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="这一次-彻底弄懂-javascript-执行机制"><a href="#这一次-彻底弄懂-javascript-执行机制" class="header-anchor">#</a> 这一次，彻底弄懂 JavaScript 执行机制</h1> <p>不论你是javascript新手还是老鸟，不论是面试求职，还是日常开发工作，
我们经常会遇到这样的情况：给定的几行代码，我们需要知道其输出内容和顺序。
因为javascript是一门单线程语言，所以我们可以得出结论：</p> <p>javascript是按照语句出现的顺序执行的
看到这里读者要打人了：我难道不知道js是一行一行执行的？还用你说？稍安勿躁，正因为js是一行一行执行的，所以我们以为js都是这样的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/images/eventLoop.jpg" alt="microInfo"></p> <p>然而实际上js是这样的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'定时器开始啦'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'马上执行for循环啦'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        i <span class="token operator">==</span> <span class="token number">99</span> <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行then函数啦'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'代码执行结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><img src="/assets/img/002.d2e5c215.jpg"> <p>依照 <strong>js是按照语句出现的顺序执行</strong> 这个理念，自信的写下输出结果：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//&quot;定时器开始啦&quot;</span>
<span class="token comment">//&quot;马上执行for循环啦&quot;</span>
<span class="token comment">//&quot;执行then函数啦&quot;</span>
<span class="token comment">//&quot;代码执行结束&quot;</span>
</code></pre></div><p>去chrome上验证下，结果完全不对，瞬间懵了，说好的一行一行执行的呢？</p> <img src="/assets/img/003.30888b15.jpg"> <p>我们真的要彻底弄明白javascript的执行机制了。</p> <h2 id="关于javascript"><a href="#关于javascript" class="header-anchor">#</a> 关于javascript</h2> <p>javascript是一门 <strong>单线程</strong> 语言，在最新的HTML5中提出了Web-Worker，但javascript是单线程这一核心仍未改变。
所以一切javascript版的&quot;多线程&quot;都是用单线程模拟出来的，一切javascript多线程都是纸老虎！</p> <h2 id="javascript事件循环"><a href="#javascript事件循环" class="header-anchor">#</a> javascript事件循环</h2> <p>既然js是单线程，那就像只有一个窗口的银行，客户需要排队一个一个办理业务，同理js任务也要一个一个顺序执行。
如果一个任务耗时过长，那么后一个任务也必须等着。
那么问题来了，假如我们想浏览新闻，但是新闻包含的超清图片加载很慢，难道我们的网页要一直卡着直到图片完全显示出来？
因此聪明的程序员将任务分为两类：</p> <ul><li>同步任务</li> <li>异步任务</li></ul> <p>当我们打开网站时，网页的渲染过程就是一大堆同步任务，比如页面骨架和页面元素的渲染。
而像加载图片音乐之类占用资源大耗时久的任务，就是异步任务。
关于这部分有严格的文字定义，但本文的目的是用最小的学习成本彻底弄懂执行机制，所以我们用导图来说明：</p> <img src="/assets/img/004.563ae489.jpg"> <p>导图要表达的内容用文字来表述的话：</p> <ul><li>同步和异步任务分别进入不同的执行&quot;场所&quot;，同步的进入主线程，异步的进入Event Table并注册函数。</li> <li>当指定的事情完成时，Event Table会将这个函数移入Event Queue。</li> <li>主线程内的任务执行完毕为空，会去Event Queue读取对应的函数，进入主线程执行。</li> <li>上述过程会不断重复，也就是常说的Event Loop(事件循环)。
我们不禁要问了，那怎么知道主线程执行栈为空啊？js引擎存在monitoring process进程，会持续不断的检查主线程执行栈是否为空，一旦为空，就会去Event Queue那里检查是否有等待被调用的函数。</li></ul> <p>说了这么多文字，不如直接一段代码更直白：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> www<span class="token punctuation">.</span>javascript<span class="token punctuation">.</span>com<span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> data<span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送成功!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'代码执行结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面是一段简易的ajax请求代码：</p> <ul><li>ajax进入Event Table，注册回调函数success。</li> <li>执行console.log('代码执行结束')。</li> <li>ajax事件完成，回调函数success进入Event Queue。</li> <li>主线程从Event Queue读取回调函数success并执行。
相信通过上面的文字和代码，你已经对js的执行顺序有了初步了解。接下来我们来研究进阶话题：setTimeout。</li></ul> <h2 id="又爱又恨的settimeout"><a href="#又爱又恨的settimeout" class="header-anchor">#</a> 又爱又恨的setTimeout</h2> <p>大名鼎鼎的setTimeout无需再多言，大家对他的第一印象就是异步可以延时执行，我们经常这么实现延时3秒执行：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'延时3秒'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><p>渐渐的setTimeout用的地方多了，问题也出现了，
有时候明明写的延时3秒，实际却5，6秒才执行函数，这又咋回事啊？</p> <p>先看一个例子：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行console'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>根据前面我们的结论，setTimeout是异步的，应该先执行console.log这个同步任务，所以我们的结论是：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//执行console</span>
<span class="token comment">//task()</span>
</code></pre></div><p>去验证一下，结果正确！ 然后我们修改一下前面的代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>

<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span>
</code></pre></div><p>乍一看其实差不多嘛，但我们把这段代码在chrome执行一下，却发现控制台执行task()需要的时间远远超过3秒，说好的延时三秒，为啥现在需要这么长时间啊？</p> <p>这时候我们需要重新理解setTimeout的定义。我们先说上述代码是怎么执行的：</p> <ul><li>task()进入Event Table并注册,计时开始。</li> <li>执行sleep函数，很慢，非常慢，计时仍在继续。</li> <li>3秒到了，计时事件timeout完成，task()进入Event Queue，但是sleep也太慢了吧，还没执行完，只好等着。</li> <li>sleep终于执行完了，task()终于从Event Queue进入了主线程执行。
上述的流程走完，我们知道setTimeout这个函数，是经过指定时间后，把要执行的任务(本例中为task())加入到Event Queue中，
又因为是单线程任务要一个一个执行，如果前面的任务需要的时间太久，那么只能等着，导致真正的延迟时间远远大于3秒。</li></ul> <p>我们还经常遇到 <strong>setTimeout(fn,0)</strong> 这样的代码，0秒后执行又是什么意思呢？是不是可以立即执行呢？</p> <p>答案是不会的，setTimeout(fn,0)的含义是，指定某个任务在主线程最早可得的空闲时间执行，意思就是不用再等多少秒了，
只要主线程执行栈内的同步任务全部执行完成，栈为空就马上执行。举例说明：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//代码1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'先执行这里'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行啦'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//先执行这里</span>
<span class="token comment">//执行啦</span>


<span class="token comment">//代码2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'先执行这里'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行啦'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token comment">//先执行这里</span>
<span class="token comment">// ... 3s later</span>
<span class="token comment">// 执行啦</span>
</code></pre></div><p>关于setTimeout要补充的是，即便主线程为空，0毫秒实际上也是达不到的。根据HTML的标准，最低是4毫秒。有兴趣的同学可以自行了解。</p> <h2 id="又恨又爱的setinterval"><a href="#又恨又爱的setinterval" class="header-anchor">#</a> 又恨又爱的setInterval</h2> <p>上面说完了setTimeout，当然不能错过它的孪生兄弟setInterval。他俩差不多，只不过后者是循环的执行。
对于执行顺序来说，setInterval会每隔指定的时间将注册的函数置入Event Queue，如果前面的任务耗时太久，那么同样需要等待。</p> <p>唯一需要注意的一点是，对于setInterval(fn,ms)来说，我们已经知道不是每过ms秒会执行一次fn，而是每过ms秒，会有fn进入Event Queue。
一旦setInterval的回调函数fn执行时间超过了延迟时间ms，那么就完全看不出来有时间间隔了。这句话请读者仔细品味。</p> <h2 id="promise与process-nexttick-callback"><a href="#promise与process-nexttick-callback" class="header-anchor">#</a> Promise与process.nextTick(callback)</h2> <p>传统的定时器我们已经研究过了，接着我们探究Promise与process.nextTick(callback)的表现。</p> <p>Promise的定义和功能本文不再赘述，不了解的读者可以学习一下阮一峰老师的<a href="https://es6.ruanyifeng.com/#docs/promise" target="_blank" rel="noopener noreferrer">Promise<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。
而process.nextTick(callback)类似node.js版的&quot;setTimeout&quot;，在事件循环的下一次循环中调用 callback 回调函数。</p> <p>我们进入正题，除了广义的同步任务和异步任务，我们对任务有更精细的定义：</p> <ul><li>macro-task(宏任务)：包括整体代码script，setTimeout，setInterval</li> <li>micro-task(微任务)：Promise，process.nextTick</li></ul> <p>不同类型的任务会进入对应的Event Queue，比如setTimeout和setInterval会进入相同的Event Queue。</p> <p>事件循环的顺序，决定js代码的执行顺序。进入整体代码(宏任务)后，开始第一次循环。
接着执行所有的微任务。然后再次从宏任务开始，找到其中一个任务队列执行完毕，再执行所有的微任务。
听起来有点绕，我们用文章最开始的一段代码说明：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'console'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>这段代码作为宏任务，进入主线程。</li> <li>先遇到setTimeout，那么将其回调函数注册后分发到宏任务Event Queue。(注册过程与上同，下文不再描述)</li> <li>接下来遇到了Promise，new Promise立即执行，then函数分发到微任务Event Queue。</li> <li>遇到console.log()，立即执行。</li> <li>好啦，整体代码script作为第一个宏任务执行结束，看看有哪些微任务？我们发现了then在微任务Event Queue里面，执行。</li> <li>k，第一轮事件循环结束了，我们开始第二轮循环，当然要从宏任务Event Queue开始。我们发现了宏任务Event Queue中setTimeout对应的回调函数，立即执行。</li> <li>结束。</li></ul> <p>事件循环，宏任务，微任务的关系如图所示：</p> <img src="/assets/img/005.eb8cfddb.jpg"> <p>我们来分析一段较复杂的代码，看看你是否真的掌握了js的执行机制：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第一轮事件循环流程分析如下：</p> <ul><li>整体script作为第一个宏任务进入主线程，遇到console.log，输出1。</li> <li>遇到setTimeout，其回调函数被分发到宏任务Event Queue中。我们暂且记为setTimeout1。</li> <li>遇到process.nextTick()，其回调函数被分发到微任务Event Queue中。我们记为process1。</li> <li>遇到Promise，new Promise直接执行，输出7。then被分发到微任务Event Queue中。我们记为then1。</li> <li>又遇到了setTimeout，其回调函数被分发到宏任务Event Queue中，我们记为setTimeout2。</li></ul> <table><thead><tr><th style="text-align:center;">宏任务Event Queue</th> <th style="text-align:center;">微任务Event Queue</th></tr></thead> <tbody><tr><td style="text-align:center;">setTimeout1</td> <td style="text-align:center;">process1</td></tr> <tr><td style="text-align:center;">setTimeout2</td> <td style="text-align:center;">then1</td></tr></tbody></table> <ul><li>上表是第一轮事件循环宏任务结束时各Event Queue的情况，此时已经输出了1和7。</li> <li>我们发现了process1和then1两个微任务。</li> <li>执行process1,输出6。</li> <li>执行then1，输出8。</li></ul> <p><strong>好了，第一轮事件循环正式结束，这一轮的结果是输出1，7，6，8。</strong></p> <p>那么第二轮时间循环从setTimeout1宏任务开始：</p> <ul><li>首先输出2。</li> <li>接下来遇到了process.nextTick()，同样将其分发到微任务Event Queue中，记为process2。</li> <li>new Promise立即执行输出4，then也分发到微任务Event Queue中，记为then2。</li></ul> <table><thead><tr><th style="text-align:center;">宏任务Event Queue</th> <th style="text-align:center;">微任务Event Queue</th></tr></thead> <tbody><tr><td style="text-align:center;">setTimeout2</td> <td style="text-align:center;">process2</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">then2</td></tr></tbody></table> <ul><li>第二轮事件循环宏任务结束，我们发现有process2和then2两个微任务可以执行。</li> <li>输出3。</li> <li>输出5。</li></ul> <p><strong>第二轮事件循环结束，第二轮输出2，4，3，5。</strong></p> <ul><li>第三轮事件循环开始，此时只剩setTimeout2了，执行。</li> <li>直接输出9。</li> <li>将process.nextTick()分发到微任务Event Queue中。记为process3。</li> <li>直接执行new Promise，输出11。</li> <li>将then分发到微任务Event Queue中，记为then3。</li></ul> <table><thead><tr><th style="text-align:center;">宏任务Event Queue</th> <th style="text-align:center;">微任务Event Queue</th></tr></thead> <tbody><tr><td style="text-align:center;"></td> <td style="text-align:center;">process3</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">then3</td></tr></tbody></table> <ul><li>第三轮事件循环宏任务执行结束，执行两个微任务process3和then3。</li> <li>输出10。</li> <li>输出12。</li></ul> <p><strong>第三轮事件循环结束，第三轮输出9，11，10，12。</strong></p> <p>整段代码，共进行了三次事件循环，完整的输出为1，7，6，8，2，4，3，5，9，11，10，12。 (请注意，node环境下的事件监听依赖libuv与前端环境不完全相同，输出顺序可能会有误差)</p> <h2 id="写在最后"><a href="#写在最后" class="header-anchor">#</a> 写在最后</h2> <p>(1)js的异步</p> <p>我们从最开头就说javascript是一门单线程语言，不管是什么新框架新语法糖实现的所谓异步，其实都是用同步的方法去模拟的，牢牢把握住单线程这点非常重要。</p> <p>(2)事件循环Event Loop</p> <p>事件循环是js实现异步的一种方法，也是js的执行机制。</p> <p>(3)javascript的执行和运行</p> <p>执行和运行有很大的区别，javascript在不同的环境下，比如node，浏览器，Ringo等等，执行方式是不同的。而运行大多指javascript解析引擎，是统一的。</p> <p>(4)setImmediate</p> <p>微任务和宏任务还有很多种类，比如setImmediate等等，执行都是有共同点的，有兴趣的同学可以自行了解。</p> <p>(5)最后的最后</p> <ul><li>javascript是一门单线程语言</li> <li>Event Loop是javascript的执行机制</li></ul> <p>牢牢把握两个基本点，以认真学习javascript为中心，早日实现成为前端高手的伟大梦想！</p> <img src="/assets/img/006.81006b80.jpg"></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">2022/6/1 16:30:10</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/Vue3/ToolFunction/"><div>
            VUE3工具函数源码解析
            <!----></div></a> <span class="date">07-11</span></dt></dl><dl><dd>02</dd> <dt><a href="/Performance/info/"><div>
            浅谈性能优化
            <!----></div></a> <span class="date">06-30</span></dt></dl><dl><dd>03</dd> <dt><a href="/React/Hooks/"><div>
            浅谈12个Hooks
            <!----></div></a> <span class="date">06-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="String" title="1051131737" target="_blank" class="iconfont icon-QQ"></a><a href="String" title="1051131737@qq.com" target="_blank" class="iconfont icon-youjian"></a><a href="String" title="jsh1051131737" target="_blank" class="iconfont icon-weixin"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2022
    <span>JSH</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><!----><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.e55f4abd.js" defer></script><script src="/assets/js/3.bc0c2498.js" defer></script><script src="/assets/js/8.97c9f6f1.js" defer></script><script src="/assets/js/22.ced87b4d.js" defer></script><script src="/assets/js/9.e2c20ecd.js" defer></script>
  </body>
</html>
